version: "3.9"
services:
  app:
    depends_on:
      - logto
    # OPTIONAL: Rebuild cheqd credential-service Docker image, if you want build your own
    # Default is to pull in the pre-published image on GitHub Container Registry
    # SYNTAX: docker compose -f docker/docker-compose.yml build
    # build:
    #   context: ../../
    #   dockerfile: docker/Dockerfile
    # CAUTION: Change image section's value if building your own image in section below
    image: ghcr.io/cheqd/credential-service:staging-latest
    ports:
      - 8787:8787
    env_file:
      - .env
    entrypoint: "npm run compose-run"

  logto:
    depends_on:
      postgres:
        condition: service_healthy
    image: ghcr.io/logto-io/logto:latest
    entrypoint: ["sh", "-c", "npm run cli db seed -- --swe && npm start"]
    ports:
      - 3001:3001
      - 3002:3002
    env_file:
      - .env

  postgres:
    image: postgres
    user: postgres
    ports:
      - 5432:5432
    env_file:
      - .env
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready" ]
      interval: 5s
      timeout: 5s
      retries: 5
